---
title: calculate_species_diversity
date: 2024
type: reference
tags: " #code/R "
description: "Code for calculating species diversity in R"
---
**Original Script by ILT**

# Load packages
```R
library(tidyverse)
library(vegan)
library(readr)
library(glmmTMB)
library(DHARMa)
library(ggplot2)
library(bbmle) 
library(nlme)
library(ncf)
library(dplyr)
library(mgcv)
library(hillR)
library(patchwork)
library(car)
library(sjPlot)
library(MuMIn)
library(corrplot)
# install.packages("hillR")
# library(cmdstanr)
# PATH_TO_CMDSTAN <- "C:/Users/ilebe/.cmdstan/cmdstan-2.31.0" # nolint
# set_cmdstan_path(PATH_TO_CMDSTAN)
# cmdstan_path()
# cmdstan_version()
```

# Set up data
```R
birds_abund <- read_csv(file.path("0_Data/Processed", "community_abundance_by_location.csv"))
# get rid of this site
birds_abund <- birds_abund |>
    filter(location != "H-RS-12-8")

# head(birds_abund)
# names(birds_abund)
# getwd()
covariates <-read_csv("0_Data/Processed/merged_covariates.csv")
dist_to_forest <- read_csv("0_Data/Processed/retn dist to nearest forest.csv")
dist_to_forest <- select(dist_to_forest, location, Dist_near_forest)
covariates <- merge(covariates, dist_to_forest, by = "location")

nrow(birds_abund) # 407
max(covariates$RETN_m2)
# Calculate the Shannon diversity index
community_matrix <- birds_abund[, 6:ncol(birds_abund)]

shannon_indices <- diversity(community_matrix, index = "shannon")
birds_abund$Shannon <- shannon_indices
View(birds_abund)

birds_abund$ESR <- exp(birds_abund$Shannon)
shannon_indices
birds_abund$Shannon <- shannon_indices
# head(birds_abund)
# Display the results
# print(shannon_indices)

# names(covariates)
# Add patch presence
covariates <- covariates %>%
      mutate(Patch = ifelse(RETN_m2 > 0, 1, 0))
# Add amount edge
covariates$Edge <- ifelse(covariates$RETN_m2 != 0 & covariates$RETN_perimeter_m !=0, 
                            covariates$RETN_m2 / covariates$RETN_perimeter_m, 0)
covariates$Year_since_logging2 <- covariates$Year_since_logging ^2
names(covariates)
selected_covariates <- covariates[, c("location", "percent_decid", "percent_mixed",
                                        "percent_spruce", "percent_pine", "Patch",
                                        "RETN_m2", "RETN_perimeter_m",
                                        "Year_since_logging", "Veg_cat", 
                                        "Dist_near_forest", "Edge", "Year_since_logging2")]
birds_abund_covs <- merge(selected_covariates, birds_abund, by = "location")
# names(birds_abund_covs)
max(birds_abund_covs$Dist_near_forest)
nrow(birds_abund_covs) # 379
birds_abund_covs_noLargePatches <- birds_abund_covs |>
  filter(RETN_m2 < 12000)
nrow(birds_abund_covs_noLargePatches) # 372
predictors_to_scale <- c('RETN_m2', 'Year_since_logging', "RETN_perimeter_m", "Edge", "Year_since_logging2", "Dist_near_forest")

# Apply MinMax scaling to each predictor
birds_abund_covs_noLargePatches[, predictors_to_scale] <- lapply(birds_abund_covs_noLargePatches[, predictors_to_scale], function(x) {
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
})

# ___________________________Data preped, skip to GLMs_________________________
#3 Logitic regressions on presence/absence----
# Identify the columns with the four-letter codes
# Assuming these are all the columns after 'longitude'
code_columns <- names(birds_abund)[5:ncol(birds_abund)]
View(birds_abund)
# Add a patch presence column


birds <- birds_abund
# Apply the transformation
birds[code_columns] <- lapply(birds[code_columns], function(x) as.integer(x > 0))

# Merge the dataframes on 'location'
merged_data <- merge(birds, covariates, by = "location", all = FALSE)
View(merged_data)

ggplot(merged_data, aes(x = RETN_m2)) +
  geom_histogram()

# This data has a few really large retention pathces. Let;s get rid of those
pres_abs_covs_noLargePatches <- merged_data |>
  filter(RETN_m2 < 12000)

```

# Data Exploration
```R
# Pivot the data to long format
birds_data_long <- pres_abs_covs_noLargePatches %>%
  pivot_longer(ALFL:PAWR, names_to = "spp", values_to = "presabs")

# View the first few rows of the transformed data
head(birds_data_long)

# birds_data_long <- bind_cols(birds_env, birds) |> 
#   pivot_longer(OSFL:YRWA, names_to = "spp", values_to = "presabs")

birds_data_long |> 
  ggplot(aes(x = RETN_m2, y = presabs)) + 
  geom_point() + 
  stat_smooth(method = "glm", method.args = list(family = "binomial")) + 
  facet_wrap(~spp)

birds_data_long |> 
  ggplot(aes(x = Year_since_logging, y = presabs)) + 
  geom_point() + 
  stat_smooth(method = "glm", method.args = list(family = "binomial")) + 
  facet_wrap(~spp)

birds_many_glms <- birds_data_long |> 
  nest_by(spp) |> 
  mutate(logistic_regressions = list(
    glm(presabs ~ Year_since_logging,
        family = "binomial",
        data = data))) |> 
  mutate(coefs = list(broom::tidy(logistic_regressions)))

birds_many_glm_coefs <- birds_many_glms |> 
  select(-data, -logistic_regressions) |> 
  unnest(coefs)

birds_many_glm_coefs |> 
  ggplot(aes(x = estimate, y = spp,
             xmin = estimate - std.error,
             xmax = estimate + std.error)) + 
  geom_pointrange() + 
  facet_wrap(~term, scales = "free")

birds_many_glm_coefs |> 
  ggplot(aes(x = estimate)) + 
  geom_histogram(binwidth = .5) + 
  facet_wrap(~term, scales = "free")

ggplot(birds_abund_covs_noLargePatches, aes(x = RETN_m2)) +
  geom_histogram()  
```


# Collinearity, data distribution
```R 
# Assuming your_data is your dataframe and it contains only predictor variables
covs_for_cor_test <- covariates[, c("Patch",
                                        "RETN_m2",
                                        "Year_since_logging", 
                                        "Dist_near_forest", "Edge", "Year_since_logging2")]
correlation_matrix <- cor(covs_for_cor_test)
View(correlation_matrix)


corrplot(correlation_matrix, method = "circle")

hist(birds_abund_covs_noLargePatches$richness)
mean(birds_abund_covs_noLargePatches$richness)
sd(birds_abund_covs_noLargePatches$richness)
hist(rlnorm(372, log(7.07), log(3.07)))
```

# Exponential Shannon index
```R
#4 Shannon Diversity----
# Distance to nearest forest is significant and negative, so I'll include that in all the models
diversity_glm0 <- glmmTMB(ESR ~ RETN_m2 + Year_since_logging  + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm0)
AIC(diversity_glm0) # 1819.405

diversity_glm1 <- glmmTMB(ESR ~ RETN_m2 + Year_since_logging  + Veg_cat,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm1)
AIC(diversity_glm1) #[1] 1823.513

diversity_glm2 <- glmmTMB(ESR ~ Edge + Year_since_logging  + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm2)
AIC(diversity_glm2) # 1819.42

diversity_glm2b <- glmmTMB(ESR ~ RETN_m2 + Year_since_logging  + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm2b)
AIC(diversity_glm2b) # 1819.405

# Best AIC so far
diversity_glm3a <- glmmTMB(ESR ~ RETN_m2 + Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm3a)
AIC(diversity_glm3a) # 1815.462
r.squaredGLMM(diversity_glm3a) # 0.04283247
plot(simulateResiduals(diversity_glm3a)) # Residuals are good.

# Same AIC, also top model
diversity_glm3b <- glmmTMB(ESR ~ Edge + Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm3b)
AIC(diversity_glm3b) # 1815.48
r.squaredGLMM(diversity_glm3b) # 0.0428
plot(simulateResiduals(diversity_glm3b)) # Residuals are good.

# Same AIC, top model
diversity_glm3aa <- glmmTMB(ESR ~ RETN_m2 + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm3aa)
AIC(diversity_glm3aa) # 1815.335
r.squaredGLMM(diversity_glm3aa) # 0.04829
plot(simulateResiduals(diversity_glm3aa)) # Resids good, some deviance but not significant

# Same AIC, top model
diversity_glm3bb <- glmmTMB(ESR ~ Edge + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm3bb)
AIC(diversity_glm3bb) # 1815.398
r.squaredGLMM(diversity_glm3bb) # 0.04829
plot(simulateResiduals(diversity_glm3bb)) # Resids good, some deviance but not significant

diversity_glm4 <- glmmTMB(ESR ~ Edge + Patch*Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm4)
AIC(diversity_glm4) # 1819.052

diversity_glm5 <- glmmTMB(ESR ~ RETN_m2 + Patch*Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm5)
AIC(diversity_glm5) #  1819.208

diversity_glm6 <- glmmTMB(ESR ~ RETN_m2 + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm6)
AIC(diversity_glm6) # 1819.019

diversity_glm6 <- glmmTMB(ESR ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm6)
AIC(diversity_glm6) # 1818.742

```

# Shannon diveristy index
```R
diversityIndex_glm <- glmmTMB(Shannon ~ RETN_m2 + Year_since_logging  + Veg_cat,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(diversity_glm)
summary(diversityIndex_glm)

gam_ESR <- gam(ESR ~ s(Year_since_logging) + RETN_m2,
                    data = birds_abund_covs_noLargePatches,
                    family=gaussian)    
summary(gam_ESR)
plot(gam_ESR)
plot(simulateResiduals(diversity_glm))

par(mfrow=c(1,1))
names(birds_abund_covs)

divers_GAm <- gam(divers_resd ~ s(longitude.y, latitude.y), data = birds_abund_covs, family = gaussian)
plot(divers_GAm)
summary(divers_GAm)
autoXY <- fitted(divers_GAm) 

diversity_glm_autoXY <- glmmTMB(Shannon ~ RETN_m2 + Year_since_logging  + Veg_cat
                                    + autoXY
                                    + (1|location),
                        data = birds_abund_covs,
                        family = gaussian)

summary(diversity_glm_autoXY)
plot(simulateResiduals(diversity_glm_autoXY))

divers_resd_XY <- residuals(diversity_glm_autoXY)

corr <- spline.correlog(birds_abund_covs$longitude.y, birds_abund_covs$latitude.y, divers_resd, resamp = 99, type = "boot")
corrXY <- spline.correlog(birds_abund_covs$longitude.y, birds_abund_covs$latitude.y, divers_resd_XY, resamp = 99, type = "boot")

par(mfrow=c(1,2))
plot(corr, main='null model')
plot(corrXY, main='spatial model')
```

# Hill taxonomic diversity
# Hill 0: Testing models
```R
#5 Richness and evenness----
# hill_taxa (q=0) will give richness
species_data <- birds_abund_covs_noLargePatches[, 18:(ncol(birds_abund_covs_noLargePatches)-2)]  # Adjust the column indices as per your data
# ?hill_taxa
# Hill taxonomic indices
# Hill number, q = 0 (default) to get species richness, q = 1 to get shannon entropy, q = 2 will give inverse Simpson.
birds_abund_covs_noLargePatches$richness <- hill_taxa(comm= species_data, q=0)
birds_abund_covs_noLargePatches$Sentropy <- hill_taxa(comm= species_data, q=1)
birds_abund_covs_noLargePatches$evenness <- hill_taxa(comm= species_data, q=2)
# ?hill_taxa()
# ?AIC
## Cannot have an evenness when there are no species
birds_abund_covs_noLargePatches <- birds_abund_covs_noLargePatches |>
                                            filter(evenness != "Inf") # 367
nrow(birds_abund_covs_noLargePatches)                                            
# community_covs_positives$Veg_cat <- as.factor(community_covs_positives$Veg_cat)
birds_abund_covs_noLargePatches$Veg_cat <- as.factor(birds_abund_covs_noLargePatches$Veg_cat)
# species_data$BTNW
# CAWA <-birds_abund |>
#       filter(CAWA > 0)
View(birds_abund_covs_noLargePatches)

# write.csv(community_covs_positives, file.path("0_Data/Processed", "Community_scaled.csv")
hill_richnull <- glmmTMB(richness ~ Patch,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_richnull)
AIC(hill_richnull) # [1] 1854.639


hill_rich0 <- glmmTMB(richness ~ RETN_m2 + Year_since_logging,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich0)
AIC(hill_rich0) # 1918.38

hill_rich1 <- glmmTMB(richness ~ RETN_m2 + Year_since_logging  + Veg_cat,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich1)
AIC(hill_rich1) # 1919.529

hill_rich2 <- glmmTMB(richness ~ RETN_m2 + Year_since_logging  + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich2)
AIC(hill_rich2) #[1] 1908.43

hill_rich2b <- glmmTMB(richness ~ Edge + Year_since_logging  + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich2b)
AIC(hill_rich2b) #  1908.471

# Year_since_logging2 marginally significant
hill_rich3 <- glmmTMB(richness ~ RETN_m2 + Year_since_logging + poly(Year_since_logging2) + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich3)
AIC(hill_rich3) # 1907.614
r.squaredGLMM(hill_rich3) # R2c 0.08082584

hill_rich3b <- glmmTMB(richness ~ Edge + Year_since_logging + poly(Year_since_logging2) + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich3b)
AIC(hill_rich3b) # 1907.699

hill_rich4 <- glmmTMB(richness ~ RETN_m2 + Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich4)
AIC(hill_rich4) #  1907.088
# r.squaredGLMM(diversity_glm3a) # 0.04283247
# plot(simulateResiduals(diversity_glm3a)) # Residuals are good.

hill_rich4b <- glmmTMB(richness ~ Edge + Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich4b)
AIC(hill_rich4b) # 1907.13
# r.squaredGLMM(diversity_glm3b) # 0.0428
# plot(simulateResiduals(diversity_glm3b)) # Residuals are good.

# New best!
hill_rich5 <- glmmTMB(richness ~ RETN_m2 + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich5)
AIC(hill_rich5) # 1905.764
r.squaredGLMM(hill_rich5) # lognormal R2m = 0.07141641
plot(simulateResiduals(hill_rich5)) # Issues with residuals

# Same AIC, top model
hill_rich5b <- glmmTMB(richness ~ Edge + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich5b)
AIC(hill_rich5b) #1905.881
r.squaredGLMM(hill_rich5b) # lognormal R2m = 0.07099881
plot(simulateResiduals(hill_rich5b)) # Issues with residuals

hill_rich6 <- glmmTMB(richness ~ Edge + Patch*Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich6)
AIC(hill_rich6) # 1910.68

hill_rich6b <- glmmTMB(richness ~ RETN_m2 + Patch*Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich6b)
AIC(hill_rich6b) #  1910.873

# Better R2
hill_rich7a <- glmmTMB(richness ~ RETN_m2 + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7a)
AIC(hill_rich7a) # 1905.66
r.squaredGLMM(hill_rich7a) # lognormal R2m = 0.10408461
plot(simulateResiduals(hill_rich7a)) # Minor dispersion issues

# Best R2 so far
hill_rich7aa <- glmmTMB(richness ~ RETN_m2 + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7aa)
AIC(hill_rich7aa) # 1904.696
r.squaredGLMM(hill_rich7aa) # lognormal R2m = 0.11262006
plot(simulateResiduals(hill_rich7aa)) # Minor dispersion issues

# Smae AIC as top model
hill_rich7b <- glmmTMB(richness ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7b)
AIC(hill_rich7b) # 1905.269
r.squaredGLMM(hill_rich7b) # lognormal R2m = 0.10504981
plot(simulateResiduals(hill_rich7b)) # Minor dispersion issues

# Even better R2. This will be the top model
hill_rich7bb <- glmmTMB(richness ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7bb)
AIC(hill_rich7bb) # 1904.439
r.squaredGLMM(hill_rich7bb) # lognormal R2m = 0.1070286
plot(simulateResiduals(hill_rich7bb)) # Dispersion 

hill_rich10re <-  glmmTMB(richness ~ Year_since_logging + Dist_near_forest + poly(Year_since_logging2) + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
AIC(hill_rich10re) # 1829.083
summary(hill_rich10re)
AIC(hill_rich10re) # 1904.439
r.squaredGLMM(hill_rich10re) # lognormal R2m = 0.1070286
plot(simulateResiduals(hill_rich10re))

hill_rich10 <-  glmmTMB(richness ~ Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
AIC(hill_rich10) # 1831.558
```

# Hill 0: Comparing top models
```R
# This is the best model
hill_rich10re <-  glmmTMB(richness ~ Year_since_logging + Dist_near_forest + poly(Year_since_logging2) + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
hill_rich10 <-  glmmTMB(richness ~ Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
hill_rich10nb <-  glmmTMB(richness ~ Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = nbinom1)
AIC(hill_rich10re) # 1829.083
summary(hill_rich10re)
nrow(birds_abund_covs_noLargePatches)
r.squaredGLMM(hill_rich10re) # delta R2m = 0.2573984
plot(simulateResiduals(hill_rich10nb)) # Residuals ok

hill_rich5bre <- glmmTMB(richness ~ Edge + Year_since_logging + Dist_near_forest + poly(Year_since_logging2) + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich5bre)
AIC(hill_rich5bre) #1896.516
r.squaredGLMM(hill_rich5bre) # delat R2c = 0.2571836
plot(simulateResiduals(hill_rich5bre)) # Residuals ok

# Worse AIC
hill_rich7are <- glmmTMB(richness ~ RETN_m2 + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7a)
AIC(hill_rich7are) # 1899.086
r.squaredGLMM(hill_rich7are) # delta R2c = 0.2576462
plot(simulateResiduals(hill_rich7are)) # Residuals ok

# Worse AIC
hill_rich7aare <- glmmTMB(richness ~ RETN_m2 + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + poly(Year_since_logging2) +(1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7aare)
AIC(hill_rich7aare) # 1898.601
r.squaredGLMM(hill_rich7aare) # delta R2c = 0.2597047
plot(simulateResiduals(hill_rich7aare)) # Residuals ok

# worse AIC
hill_rich7bre <- glmmTMB(richness ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7bre)
AIC(hill_rich7bre) # 1898.772
r.squaredGLMM(hill_rich7bre) # delta R2c = 0.2595580
plot(simulateResiduals(hill_rich7bre)) # Residuals ok

# Even better R2. This will be the top model
hill_rich7bbre <- glmmTMB(richness ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + poly(Year_since_logging2) +(1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7bbre)
AIC(hill_rich7bbre) # 1898.398
r.squaredGLMM(hill_rich7bbre) # delta R2c = 0.2595580
plot(simulateResiduals(hill_rich7bbre)) # Residuals ok 

# Using this model, which is the most promising insofar as the residuals are behaving,
# we will test for spatial autocorrelation
hill_rich7bb_resids <- residuals(hill_rich7bb)

hist(hill_rich7bb_resids)
mean(hill_rich7bb_resids)
sd(hill_rich7bb_resids)
hist(rlnorm(372, mean(hill_rich7bb_resids), sd(hill_rich7bb_resids)))

# Not needed
divers_GAm <- gam(hill_rich7bb_resids ~ s(longitude, latitude), data = birds_abund_covs_noLargePatches, family = gaussian)
plot(divers_GAm)
summary(divers_GAm) # maybe some spatial correlation, Deviance explained = 14.8%
autoXY <- fitted(divers_GAm)

nrow(birds_abund_covs_noLargePatches)
length(hill_rich7bb_resids)
length(autoXY)

# sum(is.na(birds_abund_covs_noLargePatches$longitude))
# sum(is.na(birds_abund_covs_noLargePatches$latitude))
# # 1 site is missing lat and long MATHCING LENGHTS ALL GOOD
birds_abund_covs_noLargePatches |>
            filter(is.na(latitude))

# birds_abund_covs_noLargePatches$autoXY <- autoXY
# Refit hill_rich7bb with the autocorrelation factor
hill_rich7bbXY <- glmmTMB(richness ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest 
                            + poly(Year_since_logging2) + autoXY,
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich7bbXY)
AIC(hill_rich7bbXY) # 1828.341 , really good AIC
plot(simulateResiduals(hill_rich7bbXY)) # no deviance, some quantile trends visible but no significant
r.squaredGLMM(hill_rich7bbXY) # 0.2535711
divers_resd_XY <- residuals(hill_rich7bbXY) 

corr <- spline.correlog(birds_abund_covs_noLargePatches$longitude, birds_abund_covs_noLargePatches$latitude, hill_rich7bb_resids, resamp = 99, type = "boot")
corrXY <- spline.correlog(birds_abund_covs_noLargePatches$longitude, birds_abund_covs_noLargePatches$latitude, divers_resd_XY, resamp = 99, type = "boot")

par(mfrow=c(1,2))
plot(corr, main='null model')
plot(corrXY, main='spatial model')

# birds_abund_covs_noLargePatches$Veg_cat <- relevel(birds_abund_covs_noLargePatches$Veg_cat, ref = "n")
```

# Hill 0: Richness, Top model and plots 
```R 
# This is the best model
hill_rich10re <-  glmmTMB(richness ~ Year_since_logging + Dist_near_forest + poly(Year_since_logging2) + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)

# Save the top model output
hill_richsummary <- summary(hill_rich10re)
# Extract the coefficients table (fixed effects as an example)
coefficients_table <- as.data.frame(hill_richsummary$coefficients$cond) # for conditional effects
# If you want to save random effects or other parts, adjust accordingly
coefficients_table
# Save the coefficients table to a CSV file
write.csv(coefficients_table, file.path("2_Outputs/Taxonomic", "hill_rich_top_model_summary.csv"), row.names=TRUE)

## Retyring to predict data and plot
# exlcude the ranodm effects
hill_rich_no_re <- glmmTMB(richness ~ Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = poisson)
summary(hill_rich_no_re)
# Create a new data frame for predictions
predict_data_age2 <- data.frame(
  Dist_near_forest = mean(birds_abund_covs_noLargePatches$Dist_near_forest, na.rm = TRUE),
  Year_since_logging = mean(birds_abund_covs_noLargePatches$Year_since_logging, na.rm = TRUE),
  Year_since_logging2 = seq(min(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), 
                           max(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), length.out = 367))
# predict_data_age2$Year_since_logging <- sqrt(predict_data_age2$Year_since_logging2)

# Predict using the model without the random effect
predicted_no_re <- predict(hill_rich_no_re, newdata = predict_data_age2, type = "response", se.fit = TRUE)

# Add predictions and confidence intervals to the data frame
predict_data_age2$lwr <- predicted_no_re$fit - 2*predicted_no_re$se.fit
predict_data_age2$upr <- predicted_no_re$fit + 2*predicted_no_re$se.fit
predict_data_age2$predicted <- predicted_no_re$fit
View(predict_data_age2)

# Plotting harvest age
# Scaled back
predict_data_age2$Original_Year_since_logging <- sqrt(predict_data_age2$Year_since_logging2) * 22

# Update plotting code
Age2_plot_scaled <- predict_data_age2 %>%
  ggplot(aes(x = Original_Year_since_logging, y = predicted, group = 1)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = 'grey', alpha = .4, linetype = 0) +
  geom_line() +
  geom_point(data = birds_abund_covs_noLargePatches, 
            aes(x = Year_since_logging * 22, y = richness, group = 1), 
            size = 0.5,
            alpha = .3,
            position = "jitter") + # Adjust for actual data points if necessary
  theme_minimal() +
  ylab("Species richness") +
  xlab("Year since logging") +
  # scale_y_continuous(limits = c(min(predict_data_age2$lwr, na.rm = TRUE), max(predict_data_age2$upr, na.rm = TRUE))) +
  scale_x_continuous(limits = c(0, 22)) + # Explicitly set x-axis limits
  theme(legend.position = "none", 
        axis.text=element_text(size=12),
        axis.title=element_text(size=14))
# ?geom_point
print(Age2_plot_scaled)

ggsave(filename = file.path("2_Outputs/Taxonomic", "Species richness and year since logging2.png"), plot = Age2_plot_scaled, width = 5, height = 4)

# Distance plot
# Create a new data frame for distance predictions
predict_data_distance <- data.frame(
  Dist_near_forest = seq(min(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), 
                           max(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), length.out = 367),
  Year_since_logging = mean(birds_abund_covs_noLargePatches$Year_since_logging, na.rm = TRUE),
  Year_since_logging2 = mean(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE))

# Predict using the model without the random effect
predicted_no_re <- predict(hill_rich_no_re, newdata = predict_data_distance, type = "response", se.fit = TRUE)

# Add predictions and confidence intervals to the data frame
predict_data_distance$lwr <- predicted_no_re$fit - 2*predicted_no_re$se.fit
predict_data_distance$upr <- predicted_no_re$fit + 2*predicted_no_re$se.fit
predict_data_distance$predicted <- predicted_no_re$fit
# View(predict_data_age2)

predict_data_distance$Original_distance <- predict_data_distance$Dist_near_forest * 986

distance_plot_scaled <- predict_data_distance %>%
  ggplot(aes(x = Original_distance, y = predicted, group = 1)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = 'grey', alpha = .4, linetype = 0) +
  geom_line() +
  geom_point(data = birds_abund_covs_noLargePatches, 
            aes(x = Dist_near_forest * 986, y = richness, group = 1), 
            size = 0.5,
            alpha = .3,
            position = "jitter") + # Adjust for actual data points if necessary
  theme_minimal() +
  ylab("Species richness") +
  xlab("Distance nearest unharvest forest (m)") +
  # scale_y_continuous(limits = c(min(predict_data_age2$lwr, na.rm = TRUE), max(predict_data_age2$upr, na.rm = TRUE))) +
  scale_x_continuous(limits = c(0, 750)) + # Explicitly set x-axis limits
  theme(legend.position = "none", 
        axis.text=element_text(size=12),
        axis.title=element_text(size=14))
# ?geom_point
print(distance_plot_scaled)

ggsave(filename = file.path("2_Outputs/Taxonomic", "Species richness and distance forest.png"), plot = distance_plot_scaled, width = 5, height = 4)

# plot_model(hill_rich5re, "est")
# plot_model(distance_forest_3, type = "std")
```
# Hill 1: testing models
Hill 1 is the Shannon entropy
```R

birds_abund_covs_noLargePatches$Sentropy
hill_richnull <- glmmTMB(Sentropy ~ Patch,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_richnull)
AIC(hill_richnull) # 1782.918

hill_rich00 <- glmmTMB(Sentropy ~ RETN_m2,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich00)
AIC(hill_rich00) # 1782.58

hill_rich0 <- glmmTMB(Sentropy ~ RETN_m2 + Year_since_logging,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich0)
AIC(hill_rich0) # 1774.027

# edge better by 0.5 than RETN_m2
hill_rich0b <- glmmTMB(Sentropy ~ Edge + Year_since_logging,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich0b)
AIC(hill_rich0b) # 1773.545

# worse when including Veg_cat
hill_rich1 <- glmmTMB(Sentropy ~ RETN_m2 + Year_since_logging  + Veg_cat,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich1)
AIC(hill_rich1) # 1776.263

# best so far
hill_rich2 <- glmmTMB(Sentropy ~ RETN_m2 + Year_since_logging  + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich2)
AIC(hill_rich2) #[1] 1770.627

# same as best so far
hill_rich2b <- glmmTMB(Sentropy ~ Edge + Year_since_logging  + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich2b)
AIC(hill_rich2b) # 1770.396

# same as best
hill_rich3 <- glmmTMB(Sentropy ~ RETN_m2 + Year_since_logging + poly(Year_since_logging2) + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich3)
AIC(hill_rich3) # 1770.119
r.squaredGLMM(hill_rich3) # R2c 

# same as best
hill_rich3b <- glmmTMB(Sentropy ~ Edge + Year_since_logging + poly(Year_since_logging2) + Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich3b)
AIC(hill_rich3b) # 1769.887

# New best
hill_rich4 <- glmmTMB(Sentropy ~ RETN_m2 + Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich4)
AIC(hill_rich4) # 1768.084
# r.squaredGLMM(diversity_glm3a) # 0.04283247
# plot(simulateResiduals(diversity_glm3a)) # Residuals are good.

# New new best
hill_rich4b <- glmmTMB(Sentropy ~ Edge + Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich4b)
AIC(hill_rich4b) # 1767.843
r.squaredGLMM(hill_rich4b) # 0.05146281, 0.05146281
plot(simulateResiduals(hill_rich4b)) # Residuals are good.

# same as best
hill_rich5 <- glmmTMB(Sentropy ~ RETN_m2 + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich5)
AIC(hill_rich5) # 1767.213
r.squaredGLMM(hill_rich5) # 0.05825358 0.05825358
plot(simulateResiduals(hill_rich5)) # Residuals are good.

# Same AIC as top model
hill_rich5b <- glmmTMB(Sentropy ~ Edge + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich5b)
AIC(hill_rich5b) #1767.004
r.squaredGLMM(hill_rich5b) # 0.05878968 0.05878968
plot(simulateResiduals(hill_rich5b)) # Residuals are good.

# worse
hill_rich6 <- glmmTMB(Sentropy ~ Edge + Patch*Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich6)
AIC(hill_rich6) # 1771.786

# worse
hill_rich6b <- glmmTMB(Sentropy ~ RETN_m2 + Patch*Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich6b)
AIC(hill_rich6b) #  1772.068

# worse
hill_rich7a <- glmmTMB(Sentropy ~ RETN_m2 + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich7a)
AIC(hill_rich7a) # 1773.118
r.squaredGLMM(hill_rich7a) # lognormal R2m = 0.10408461
plot(simulateResiduals(hill_rich7a)) # Minor dispersion issues

# worse AIC
hill_rich7aa <- glmmTMB(Sentropy ~ RETN_m2 + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich7aa)
AIC(hill_rich7aa) # 1772.275
r.squaredGLMM(hill_rich7aa) # lognormal R2m = 0.11262006
plot(simulateResiduals(hill_rich7aa)) # Minor dispersion issues

# worse aic
hill_rich7b <- glmmTMB(Sentropy ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich7b)
AIC(hill_rich7b) # 1774.713
r.squaredGLMM(hill_rich7b) # lognormal R2m = 0.10504981
plot(simulateResiduals(hill_rich7b)) # Minor dispersion issues

# worse aic
hill_rich7bb <- glmmTMB(Sentropy ~ Edge + Patch*Year_since_logging + Patch*Veg_cat + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich7bb)
AIC(hill_rich7bb) # 1771.969
r.squaredGLMM(hill_rich7bb) # lognormal R2m = 0.1070286
plot(simulateResiduals(hill_rich7bb)) # Dispersion 

```

# Hill1: comparing top models 
```R 
# New new best
hill_rich4b <- glmmTMB(Sentropy ~ Edge + Year_since_logging + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich4b)
AIC(hill_rich4b) # 1767.843
r.squaredGLMM(hill_rich4b) # 0.05146281, 0.05146281
plot(simulateResiduals(hill_rich4b)) # Residuals are good.

# same as best
hill_rich5 <- glmmTMB(Sentropy ~ RETN_m2 + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich5)
AIC(hill_rich5) # 1767.213
r.squaredGLMM(hill_rich5) # 0.05825358 0.05825358
plot(simulateResiduals(hill_rich5)) # Residuals are good.

# Same AIC as top model
hill_rich5b <- glmmTMB(Sentropy ~ Edge + Year_since_logging + Dist_near_forest + poly(Year_since_logging2),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich5b)
AIC(hill_rich5b) #1767.004
r.squaredGLMM(hill_rich5b) # 0.05878968 0.05878968
plot(simulateResiduals(hill_rich5b)) # Residuals are good.

# best
hill_rich10 <- glmmTMB(Sentropy ~ Edge + poly(Year_since_logging2) + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich10)
AIC(hill_rich10) # 1765.628
r.squaredGLMM(hill_rich10) #0.05718595 0.05718595
plot(simulateResiduals(hill_rich10)) # Residuals are good.

hill_rich10re <- glmmTMB(Sentropy ~ Edge + poly(Year_since_logging2) + Dist_near_forest + (1|location),
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich10re)
AIC(hill_rich10re) # 1767.628
r.squaredGLMM(hill_rich10re) # 0.05718459 0.8933991
plot(simulateResiduals(hill_rich10re)) # Residuals are good.

hill_rich11 <- glmmTMB(Sentropy ~ poly(Year_since_logging2) + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
summary(hill_rich11)
AIC(hill_rich11) # 1763.85
r.squaredGLMM(hill_rich11) # 0.05661373 0.05661373
plot(simulateResiduals(hill_rich11)) # Residuals are good.

```

# Hill 1: Plotting top model 
```R 
hill_rich10 <- glmmTMB(Sentropy ~ Edge + poly(Year_since_logging2) + Dist_near_forest,
                        data = birds_abund_covs_noLargePatches,
                        family = gaussian)
r.squaredGLMM(hill_rich10) # 0.05718595 0.05718595
  # Save the top model output
hill_rich10_summary <- summary(hill_rich10)
hill_rich10_summary
# Extract the coefficients table (fixed effects as an example)
coefficients_table <- as.data.frame(hill_rich10_summary$coefficients$cond) # for conditional effects
coefficients_table

# Save the coefficients table to a CSV file
write.csv(coefficients_table, file.path("2_Outputs/Taxonomic", "hill_shannon_entropy_summary.csv"), row.names=TRUE)

# Create a new data frame for predictions
predict_data_age2 <- data.frame(
  Edge = mean(birds_abund_covs_noLargePatches$Edge, na.rm = TRUE),
  Dist_near_forest = mean(birds_abund_covs_noLargePatches$Dist_near_forest, na.rm = TRUE),
  Year_since_logging2 = seq(min(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), 
                           max(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), length.out = 367))
predict_data_age2$Year_since_logging <- sqrt(predict_data_age2$Year_since_logging2)

# Predict using the model without a random effect
predicted_no_re <- predict(hill_rich10, newdata = predict_data_age2, type = "response", se.fit = TRUE)

# Add predictions and confidence intervals to the data frame
predict_data_age2$lwr <- predicted_no_re$fit - 2*predicted_no_re$se.fit
predict_data_age2$upr <- predicted_no_re$fit + 2*predicted_no_re$se.fit
predict_data_age2$predicted <- predicted_no_re$fit
# View(predict_data_age2)

# Plotting harvest age
# Scaled back
predict_data_age2$Original_Year_since_logging <- sqrt(predict_data_age2$Year_since_logging2) * 22

# Update plotting code
Age2_plot_scaled <- predict_data_age2 %>%
  ggplot(aes(x = Original_Year_since_logging, y = predicted, group = 1)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = 'grey', alpha = .4, linetype = 0) +
  geom_line() +
  geom_point(data = birds_abund_covs_noLargePatches, 
            aes(x = Year_since_logging * 22, y = Sentropy, group = 1), 
            size = 0.5,
            alpha = .3,
            position = "jitter") + # Adjust for actual data points if necessary
  theme_minimal() +
  ylab("Shanon entropy") +
  xlab("Year since logging") +
  # scale_y_continuous(limits = c(min(predict_data_age2$lwr, na.rm = TRUE), max(predict_data_age2$upr, na.rm = TRUE))) +
  scale_x_continuous(limits = c(0, 22)) + # Explicitly set x-axis limits
  theme(legend.position = "none", 
        axis.text=element_text(size=12),
        axis.title=element_text(size=14))
# ?geom_point
print(Age2_plot_scaled)

ggsave(filename = file.path("2_Outputs/Taxonomic", "Shanon entropy and year since logging2.png"), plot = Age2_plot_scaled, width = 5, height = 4)

# Distance plot
# Create a new data frame for distance predictions
predict_data_distance <- data.frame(
  Dist_near_forest = seq(min(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), 
                           max(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE), length.out = 367),
  Edge = mean(birds_abund_covs_noLargePatches$Edge, na.rm = TRUE),
  Year_since_logging2 = mean(birds_abund_covs_noLargePatches$Year_since_logging2, na.rm = TRUE))

# Predict using the model without the random effect
predicted_no_re <- predict(hill_rich10, newdata = predict_data_distance, type = "response", se.fit = TRUE)

# Add predictions and confidence intervals to the data frame
predict_data_distance$lwr <- predicted_no_re$fit - 2*predicted_no_re$se.fit
predict_data_distance$upr <- predicted_no_re$fit + 2*predicted_no_re$se.fit
predict_data_distance$predicted <- predicted_no_re$fit
# View(predict_data_age2)

predict_data_distance$Original_distance <- predict_data_distance$Dist_near_forest * 986

distance_plot_scaled <- predict_data_distance %>%
  ggplot(aes(x = Original_distance, y = predicted, group = 1)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = 'grey', alpha = .4, linetype = 0) +
  geom_line() +
  geom_point(data = birds_abund_covs_noLargePatches, 
            aes(x = Dist_near_forest * 986, y = Sentropy, group = 1), 
            size = 0.5,
            alpha = .3,
            position = "jitter") + # Adjust for actual data points if necessary
  theme_minimal() +
  ylab("Shannon entropy") +
  xlab("Distance nearest unharvest forest (m)") +
  # scale_y_continuous(limits = c(min(predict_data_age2$lwr, na.rm = TRUE), max(predict_data_age2$upr, na.rm = TRUE))) +
  scale_x_continuous(limits = c(0, 750)) + # Explicitly set x-axis limits
  theme(legend.position = "none", 
        axis.text=element_text(size=12),
        axis.title=element_text(size=14))
# ?geom_point
print(distance_plot_scaled)

ggsave(filename = file.path("2_Outputs/Taxonomic", "Shanon entropy and distance forest.png"), plot = distance_plot_scaled, width = 5, height = 4)
                 

```

# GAM on the non-linear effect of age: richness
```R
gam_richness1 <- gam(richness ~ s(Year_since_logging),
                    data = community_covs_scaled,
                    family=poisson)   
summary(gam_richness1)
plot(gam_richness1)
AIC(gam_richness1)
gam_richness2 <- gam(richness ~ s(Year_since_logging) + RETN_m2,
                    data = community_covs_scaled,
                    family=poisson)    
summary(gam_richness2)
plot(gam_richness2)
AIC(gam_richness2)

gam_richness3 <- gam(richness ~ s(Year_since_logging) + RETN_m2 + Veg_cat,
                    data = community_covs_scaled,
                    family=poisson)    
summary(gam_richness3)
png(file.path("2_Outputs", "richness gam.png"), width = 400, height = 400)

plot(gam_richness3, residuals=FALSE, rug = FALSE, all.terms = FALSE, 
      ylab = "Effect of year since logging on Richness",
      xlab = "Year since logging, scaled from 0-22 years")
dev.off()
AIC(gam_richness3)

gam_richness4 <- gam(richness ~ s(Year_since_logging) + RETN_m2 * Veg_cat,
                    data = community_covs_scaled,
                    family=poisson)    
summary(gam_richness4)
plot(gam_richness4)
AIC(gam_richness4)

gam_richness5 <- gam(richness ~ s(Year_since_logging) + Veg_cat,
                    data = community_covs_scaled,
                    family=poisson)    
summary(gam_richness5)
plot(gam_richness5)
AIC(gam_richness5)

birds_abund_covs_noLargePatches |>
        ggplot(aes(x = RETN_m2, y = richness, color = Veg_cat)) +
        geom_point()
      
comm_evenness <- glmmTMB(evenness ~ percent_decid + percent_pine + 
                            percent_spruce +
                            RETN_m2 + Year_since_logging,
                    data = community_covs_scaled,
                    family=gaussian)
summary(comm_evenness)

png(file.path("2_Outputs", "evenness gam.png"), width = 400, height = 400)

gam_evenness <- gam(evenness ~ s(Year_since_logging),
                    data = community_covs_scaled,
                    family=gaussian)    
summary(gam_evenness)
plot(gam_evenness,
      ylab = "Effect of year since logging on Richness",
      xlab = "Year since logging, scaled from 0-22 years")
dev.off()
AIC(gam_evenness)

gam_evenness2 <- gam(evenness ~ s(Year_since_logging) + RETN_m2,
                    data = community_covs_scaled,
                    family=gaussian)    
summary(gam_evenness2)
plot(gam_evenness2)
AIC(gam_evenness2)

gam_evenness3 <- gam(evenness ~ s(Year_since_logging) + RETN_m2 + Veg_cat,
                    data = community_covs_scaled,
                    family=gaussian)    
summary(gam_evenness3)
plot(gam_evenness3)
AIC(gam_evenness3)

gam_evenness4 <- gam(evenness ~ s(Year_since_logging) + RETN_m2 * Veg_cat,
                    data = community_covs_scaled,
                    family=gaussian)    
summary(gam_evenness4)
plot(gam_evenness4)
AIC(gam_evenness4)

# Extract fitted values
community_covs_scaled$fitted_evenness <- fitted(comm_evenness)

# Create the plot
ggplot(community_covs_scaled, aes(x = Year_since_logging, y = fitted_evenness)) +
  geom_line() +  # or geom_line() if you prefer a line plot
  xlab("Year Since Logging") +
  ylab("Fitted Evenness") +
  ggtitle("Fitted Evenness over Years Since Logging")

community_covs_scaled |>
        ggplot(aes(x = RETN_m2, y = evenness, color = Veg_cat)) +
        geom_point()

comm_evenness_interact <- glmmTMB(evenness ~  RETN_m2 * Year_since_logging * Veg_cat,
                    data = birds_abund_covs_positives,
                    family=gaussian)
summary(comm_evenness_interact)

png(file.path("2_Outputs", "richness and evenness.png"), width = 1000, height = 1000)
# par(mfrow=c(2, 2))
# Create a simple plot showing how evenness changes with age
p1 <- ggplot(community_covs_scaled, aes(x = Year_since_logging, y = evenness)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "gaussian"))

# Create a simple plot showing how evenness changes with age
p2 <- ggplot(community_covs_scaled, aes(x = Year_since_logging, y = richness)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "poisson"))

# Combine the plots side by side
combined_plot <- p1 + p2 +
  plot_layout(widths = c(1, 1), heights = c(1,1))

# Print the combined plot
combined_plot

dev.off()
# Create a plot with the effect of year_since_harvest holding all other variables constant

# Create a new data frame for predictions
predict_data <- data.frame(
  percent_decid = mean(community_covs_scaled$percent_decid, na.rm = TRUE),
  percent_pine = mean(community_covs_scaled$percent_pine, na.rm = TRUE),
  percent_spruce = mean(community_covs_scaled$percent_spruce, na.rm = TRUE),
  RETN_m2 = mean(community_covs_scaled$RETN_m2, na.rm = TRUE),
  Year_since_logging = seq(min(community_covs_scaled$Year_since_logging, na.rm = TRUE), 
                           max(community_covs_scaled$Year_since_logging, na.rm = TRUE), length.out = 100)
)

# Get predictions
predict_data$predicted_evenness <- predict(comm_evenness, newdata = predict_data, type = "response")

# Create the plot with raw data and the prediction line
community_covs_scaled %>%
  ggplot(aes(x = Year_since_logging, y = evenness)) +
  geom_point() +
  geom_line(data = predict_data, aes(x = Year_since_logging, y = predicted_evenness), color = "blue") +
  # geom_ribbon(data = predict_data, aes(ymin = predicted_evenness - 1.96 * se, ymax = predicted_evenness + 1.96 * se), alpha = 0.2) +
  xlab("Year Since Logging") +
  ylab("Evenness")

BTNW <- birds_abund_covs_positives |>
                      filter(BTNW > 0)
View(BTNW)
write.csv(INF, file.path("0_Data/Processed", 'sites with no detections & no bad weather.csv'))
```



# dbRDA 
```R
#6 Distance-based redundancy analysis, continuous predictors----
## dbRDA
# write.csv(birds_abund_covs_noLargePatches, file.path("0_Data/Processed", "birds_abund_covs_noLargePatches.csv"))
# Prepare species abundance data (assuming these are the last columns, adjust as needed)
# View(community_covs)
community_covs_scaled <- read.csv(file.path("0_Data/Processed", "Community_scaled.csv"))
# community_covs_scaled <- birds_abund_covs_noLargePatches

# Select speices that are present at least 3 sites
Species_detection_histories <- read.csv(file.path("0_Data/Processed", "species_detection_rate.csv"))
View(Species_detection_histories)
# Select species present in at least 3 sites
at_least_3_locations <- Species_detection_histories |>
  filter(Number.of.sites.where.detected >= 3)

# Filter to get species codes detected in at least 3 sites
vector_at_least_3_locations <- Species_detection_histories %>%
  filter(Number.of.sites.where.detected >= 3) %>%
  pull(species_code)  # Extract species codes as a vector

# Select columns from community_covs_scaled based on the filtered species codes
species_columns_at_least_3_detects <- community_covs_scaled %>%
  select(all_of(vector_at_least_3_locations))

ncol(species_columns_at_least_3_detects) # 72 species

all_species_columns <- select(community_covs_scaled, CCSP:PAWR)
ncol(all_species_columns) # 91 species total

# not_transformed_species_data <- all_species_columns # or species_columns_at_least_3_detects
not_transformed_species_data <- species_columns_at_least_3_detects # or all_species_columns
hellinger_species_data <- decostand(select(community_covs_scaled, CCSP:PAWR), method = "hellinger")
# ?decostand
head(new_species_data)
# Calculate the Bray-Curtis distance matrix
# distance_matrix <- vegdist(species_data, method = "bray")
names(birds_abund_covs)
# Environmental variables

env_data <- community_covs_scaled[, c("RETN_m2", "Year_since_logging", "percent_decid", "percent_mixed",
                                        "percent_spruce", "percent_pine", "Veg_cat")]

# Reset to default single panel plot setting
par(mfrow=c(1,1))
dev.off()
# Running dbRDA
rda_result <- rda(new_species_data ~ RETN_m2 + Year_since_logging + percent_decid
                                      + percent_spruce + percent_pine, data = env_data, distance="bray",
                                      comm = NULL)

dbrda_result <- dbrda(not_transformed_species_data ~ RETN_m2 + Year_since_logging + percent_decid
                                      + percent_spruce + percent_pine, data = env_data, distance="bray",
                                      comm = NULL)
?dbrda
rda_model <- rda(new_species_data ~ RETN_m2 + Year_since_logging + Veg_cat, data = env_data)
View(community_covs_scaled)

# View the results
summary(dbrda_result)
plot(dbrda_result)
anova(dbrda_result) #overall test of the significance of the analysis
anova(dbrda_result, by="terms", permu=200) # significance by terms
# png(file.path("2_Outputs", "dbrda plot.png"), width = 500, height = 500)
plot(dbrda_result)
dev.off()
anova(dbrda_result, by = "margin") # difference between marginal and by terms significance??

png(file.path("2_Outputs", "dbrda plot colour.png"), width = 500, height = 500)

# Add vectors for explanatory variables
# Define a color for each variable
vector_colors <- c("RETN_m2" = "red", "Year_since_logging" = "blue", "percent_decid" = "green", 
                   "percent_spruce" = "orange", "percent_pine" = "purple")
# plot(dbrda_result)
# Use ordiplot() to create a base plot
ordiplot(dbrda_result, display = "sites")

# Determine a scaling factor for arrow lengths
scale_factor <- 4  # Adjust this value as needed to match the length of arrows in the default plot

# Add scaled vectors with colors
for (var in names(vector_colors)) {
    vectors <- scores(dbrda_result, display = "bp", choices = 1:2)
    if (var %in% rownames(vectors)) {
        arrows(0, 0, vectors[var, 1] * scale_factor, vectors[var, 2] * scale_factor, col = vector_colors[var], length = 0.1)
        text(vectors[var, 1] * scale_factor, vectors[var, 2] * scale_factor, labels = var, col = vector_colors[var], pos = 3)
    }
}
dev.off()

#7 RDA with discrete groupings of retention amount----
# Read the CSV file containing the species community matrix and site covariates
community_covs <- read.csv(file.path("0_Data/Processed","birds_abund_covs_noLargePatches.csv"))

# community_covs$RETN_cat <- ifelse(community_covs$RETN_m2 == 0, 
#                         0, 
#                         cut(community_covs$RETN_m2, 
#                             breaks = c(min(community_covs$RETN_m2[community_covs$RETN_m2 > 0]), 
#                                        median(community_covs$RETN_m2[community_covs$RETN_m2 > 0]), 
#                                        max(community_covs$RETN_m2)), 
#                             include.lowest = TRUE, 
#                             labels = c("1-50%", "51-100%")))

# create_RETN_categories <- function(data, size_breaks) {
#     # Ensure size_breaks is a numeric vector and sorted
#     size_breaks <- sort(as.numeric(size_breaks))
#     print(size_breaks)
    
#     # Create a breaks vector that starts with 0 and then includes the provided size_breaks
#     size_breaks <- c(size_breaks, max(data$RETN_m2))
#     print(size_breaks)
#     # Create labels for the breaks
#     labels <- c("0%", paste0(seq_along(size_breaks), "-",
#                              c(size_breaks[-1], "100%")))
#     print(labels)
#     # Create the RETN_cat column
#     data$RETN_cat <- cut(data$RETN_m2, 
#                          breaks = size_breaks, 
#                          include.lowest = TRUE)
    
#     # Handle the special case for 0
#     data$RETN_cat[data$RETN_m2 == 0] <- "0%"

#     return(data)
# }

# community_covs <- create_RETN_categories(community_covs, c(25, 50, 75))

species_data <- select(community_covs, CCSP:PAWR)  # include only the columns for species

community_covs$evenness <- hill_taxa(comm= species_data, q=2)
## Cannot have an evenness when there are no species
community_covs_positives <- community_covs |>
                                            filter(evenness != "Inf")

predictors_to_scale <- c('RETN_m2', 'Year_since_logging')

# predictors_to_scale <- c('RETN_m2')

# Apply MinMax scaling to each predictor
community_covs_scaled <- community_covs_positives
community_covs_scaled[, predictors_to_scale] <- lapply(community_covs[, predictors_to_scale], function(x) {
  (x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
})

# community_covs_logs <- community_covs
# community_covs_logs$RETN_m2 <- lapply(community_covs$RETN_m2, function(x) {
#   (log(x+1))
# })
# Create the RETN_cat column
community_covs_scaled <- community_covs_scaled %>%
  mutate(RETN_cat = case_when(
    RETN_m2 == 0 ~ 0,
    RETN_m2 > 0 & RETN_m2 <= 0.25 ~ 1,
    RETN_m2 > 0.25 & RETN_m2 <= 0.50 ~ 2,
    RETN_m2 > 0.50 & RETN_m2 <= 0.75 ~ 3,
    RETN_m2 > 0.75 ~ 4
  ))
community_covs_scaled$RETN_cat = as.factor(community_covs_scaled$RETN_cat)

# Plotting the histogram of RETN_cat
# ggplot(community_covs_scaled, aes(x = RETN_cat)) +
#   geom_histogram(stat = "count") +
#   # scale_x_continuous(breaks = 0:4) +
#   xlab("RETN Category") +
#   ylab("Frequency")

# write.csv(community_covs_scaled, file.path("0_Data/Processed", "scaled_hellinger_community.csv"))
# Change the dataframe to scaled

species_data <- select(community_covs_scaled, CCSP:PAWR)  # Adjust the column indices as per your data

# Hellinger transformation of the species counts

hellinger_species_data <- decostand(select(community_covs_scaled, CCSP:PAWR), method = "hellinger")
# Prepare the environmental data
env_data <- community_covs_scaled[, c("RETN_cat", "Year_since_logging", "Veg_cat")]

# Perform the RDA
rda_model <- rda(hellinger_species_data ~ RETN_cat 
                  + Year_since_logging + Veg_cat, 
                  data = env_data)
# View(community_covs_positives)
# Ensure the data frame has appropriate row names
rownames(community_covs_positives) <- as.character(1:nrow(community_covs_positives))
plot(rda_model)

summary(rda_model)
anova(rda_model, by = "margin")
RsquareAdj(rda_model)

#7 Single plot RDA----
# Filter the RDA results for year_since_logging = 1 or 2
years_1_2_filtered <- community_covs_positives[community_covs_positives$Year_since_logging %in% c(1, 2, 3, 4, 5), ]

# Check for NA or infinite values in RETN_m2 and remove them if necessary
years_1_2_filtered <- na.omit(years_1_2_filtered)
years_1_2_filtered <- years_1_2_filtered[is.finite(years_1_2_filtered$RETN_m2), ]

# Ensure that the row names match between the RDA scores and the filtered data
rownames(years_1_2_filtered) <- rownames(community_covs_positives)[rownames(community_covs_positives) %in% rownames(years_1_2_filtered)]

# Get ordination scores
ordination_scores <- scores(rda_model, display = "sites")

# Adjust row names to match numeric row names in years_1_2_filtered
adjusted_row_names <- as.numeric(gsub("row", "", rownames(ordination_scores)))

# Match scores with the filtered data
matched_scores <- ordination_scores[adjusted_row_names %in% rownames(years_1_2_filtered), ]

# Check if the number of scores matches the number of group labels
if (nrow(matched_scores) == nrow(years_1_2_filtered)) {
  # Plot the RDA with ellipses for the categories of RETN_m2
  plot(rda_model, type = "n")  # Plot the RDA points
  # Draw ellipses around groups, ensure groups are factors
  ordiellipse(matched_scores, groups = factor(years_1_2_filtered$RETN_cat), 
              display = "species",
              label = TRUE,
              )
} else {
  stop("The number of ordination scores does not match the number of group labels.")
}

#8 Several RDA subplots----

rda_model <- rda(hellinger_species_data ~ RETN_cat 
                  + Year_since_logging + Veg_cat, 
                  data = env_data)
# Get ordination scores
ordination_scores <- scores(rda_model, display = "sites")
# Define the year ranges for subsetting
# year_ranges <- list(`1-4` = 1:4, `8-12` = 8:12, `18-22` = 18:22, `16-22` = 20:22)

year_ranges <- list(`1-4` = 1:4, `8-12` = 8:12, `18-22` = 18:22)
# Set up the file to save the plot
dev.off()
png(file.path("2_Outputs", "rda plots by year categories, 4 patch sizes.png"), width = 1000, height = 1000)

# Setup the plotting area for a 2x2 layout
par(mfrow=c(2, 2))

# Loop through the year ranges to create plots

subset_years <- community_covs_positives |>
  filter(Year_since_logging == 8)
nrow(subset_years)
class(community_covs_positives$Year_since_logging)
unique(community_covs_positives$Year_since_logging)
dev.off()

# Setup the plotting area for a 2x2 layout

png(file.path("2_Outputs", "rda plots by year categories, 5 patch sizes.png"), width = 500, height = 500)
par(mfrow=c(2, 2))
for (i in seq_along(year_ranges)) {
    # Reverse the Yeear_since_logging to their originl unscaled integers
    community_covs_scaled$Year_since_logging <- community_covs_positives$Year_since_logging
    # current_year_range <- year_ranges[[i]]
    years_filtered <- subset(community_covs_scaled, Year_since_logging %in% year_ranges[[i]])
    # print(community_covs_scaled$Year_since_logging)
    # print(years_filtered)

    # Ensure no NA or infinite values in the filtered data
    years_filtered <- na.omit(years_filtered)
    years_filtered <- years_filtered[is.finite(years_filtered$RETN_cat), ]
    
    # Adjust the row names as done before
    adjusted_row_names <- as.numeric(gsub("row", "", rownames(ordination_scores)))
    # print(adjusted_row_names)
    # Match scores with the filtered data
    matched_scores <- ordination_scores[adjusted_row_names %in% rownames(years_filtered), ]
# print(matched_scores)    
    years_filtered$RETN_cat <- as.factor(years_filtered$RETN_cat)
    col_palette <- palette()[years_filtered$RETN_cat]
    print(col_palette) # fixed
# print(col_palette)
      # Create the plot for the current year range
    if (nrow(matched_scores) == nrow(years_filtered)) {
      print(matched_scores)
        # Plot the RDA with ellipses for the categories of RETN_m2
        
        plot(rda_model, type = "n", main = paste("Years", names(year_ranges)[i]))
        points(matched_scores, pch = 19, cex = 0.5, col=unique(col_palette))
        ordiellipse(matched_scores, groups = factor(years_filtered$RETN_cat),
                    # conf = .95,
                    label = FALSE, col = unique(col_palette))

        legend('topright', legend=unique(years_filtered$RETN_cat), col=unique(col_palette), pch = 16,
                title = "Retention level", bty = "n")

    } else {
        stop(paste("The number of ordination scores does not match the number of group labels for the range", names(year_ranges)[i]))
    }
}

# For the fourth subplot, use the full dataset and focus on Veg_cat for ellipses
# Ensure no NA or infinite values in the full data
# data_full <- na.omit(community_covs_positives)
# data_full <- data_full[is.finite(data_full$RETN_m2), ]
# View(data_full)
adjusted_row_names <- as.numeric(gsub("row", "", rownames(ordination_scores)))
matched_scores_full <- ordination_scores[adjusted_row_names %in% rownames(community_covs_positives), ]

plot(rda_model, type = "n", main = "All sites")

# unique_veg_cats <- unique(data_full$Veg_cat)
community_covs_positives$Veg_cat <- as.factor(community_covs_positives$Veg_cat)
col_palette <- palette()[community_covs_positives$Veg_cat]

# print(unique(col_palette))
points(matched_scores_full, pch = 19, cex = 0.5, col=unique(col_palette))

ordiellipse(matched_scores_full, groups = factor(community_covs_positives$Veg_cat), 
            label = FALSE,
            col = unique(col_palette)) 

# Add a custom legend for ellipses for Veg_cat
legend("topright", legend = unique(community_covs_positives$Veg_cat), col=unique(col_palette), pch = 16, 
       title = "Veg Categories", bty = "n")

# Close the device to save the file
dev.off()

# Reset to default single panel plot setting
par(mfrow=c(1,1))
```
